@{
    Layout = "~/Views/Shared/_AdminLteLayout.cshtml";
}

<div class="box box-primary box-body" ng-controller="ownerCtrl">
    <!-- box-header -->
    <div class="box-header with-border">
        <i class="fa fa-list-alt"></i>
        <h3 class="box-title">Stage Configuration</h3>
        <div class="box-tools pull-right">
            <button type="button" id="btnRefresh" data-ng-click="toggleRefreshTable()" class="btn btn-flat pull-right"><i class="fa fa-refresh"></i> Refresh</button>
            <button type="button" id="btnAdd" data-ng-click="toggleAddDocument()" class="btn btn-flat btn-primary pull-right btnSave"> <i class="fa fa-plus"></i> Add Document</button>
            <button type="button" id="btnAdd" data-ng-click="toggleAddProperty()" class="btn btn-flat btn-primary pull-right btnSave"> <i class="fa fa-plus"></i> Add Property</button>
        </div>
    </div>
    <div class="box-body">
        <div class="row">
            <div class="col-sm-2 col-md-2 col-lg-2">
                <div class="form-group">
                    <label for="OwnerLevel">Owner Level</label>
                </div>
            </div>
            <div class="col-sm-4 col-md-4 col-lg-4">
                <div class="form-group">
                    <select class="form-control" ng-model="vmBase.OwnerLevel" ng-options="ownerLevel as ownerLevel.LevelName for ownerLevel in ownerLevels track by ownerLevel.OwnerLevelID">
                        <option value="">-- Select One --</option>
                    </select>
                </div>
            </div>
            <div class="col-sm-2 col-md-2 col-lg-2">
                <div class="form-group">
                    <label for="Owner">Owner</label>
                </div>
            </div>
            <div class="col-sm-4 col-md-4 col-lg-4">
                <div class="form-group">
                    <select class="form-control" ng-model="vmBase.Owner" data-ng-options="owner as owner.OwnerName for owner in ownersForSpecificOwnerLevel track by owner.OwnerID" data-ng-disabled="!vmBase.OwnerLevel">
                        <option value="">-- Select One --</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-2 col-md-2 col-lg-2">
                <div class="form-group">
                    <label>Document Category</label>
                </div>
            </div>
            <div class="col-sm-4 col-md-4 col-lg-4">
                <div class="form-group">
                    <select class="form-control" data-ng-model="vmBase.DocCategory" data-ng-options="docCategory as docCategory.DocCategoryName for docCategory in docCategoriesForSpecificOwner track by docCategory.DocCategoryID" data-ng-disabled="!vmBase.Owner">
                        <option value="">-- Select One --</option>
                    </select>
                </div>
            </div>
            <div class="col-sm-2 col-md-2 col-lg-2">
                <div class="form-group">
                    <label>Document Type</label>
                </div>
            </div>
            <div class="col-sm-4 col-md-4 col-lg-4">
                <div class="form-group">
                    <select id="" name="" class="form-control" data-ng-model="vmBase.DocType" data-ng-options="docType as docType.DocTypeName for docType in docTypeForSpecificDocCategory track by docType.DocTypeID" data-ng-disabled="!vmBase.DocCategory">
                        <option value="">-- Select One --</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-2 col-md-2 col-lg-2">
                <div class="form-group">
                    <label>Processing Stage</label>
                </div>
            </div>
  
            <div class="col-sm-4 col-md-4 col-lg-4">
                <div class="form-group">
                    <select id="stageMap" name="stageMap" class="form-control" ng-model="vmBase.StageMap" data-ng-options="item as item.StageName for item in stageCollection track by item.StageMapID" data-ng-disabled="!vmBase.DocType">
                        <option value="">-- Select One --</option>
                    </select>
                </div>
            </div>
            <div class="col-sm-2 col-md-2 col-lg-2">
            </div>
            <div class="col-sm-4 col-md-4 col-lg-4">
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-condensed table-bordered table-striped table-hover pnlView">
            <thead>
                <tr>
                    <th>DocumentID</th>
                    <th>Document Title</th>
                    <th>Serial</th>
                    <th>Is Required</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="row in documentsCollection">
                    <td class="col-lg-1 col-md-1 col-sm-1">{{row.DocPropertyID}}</td>
                    <td class="col-lg-4 col-md-4 col-sm-4">{{row.DocPropertyName | uppercase}}</td>
                    <td class="col-lg-1 col-md-1 col-sm-1">{{row.SerialNo}}</td>
                    <td class="col-lg-1 col-md-1 col-sm-1 text-center">
                        <span ng-attr-class="{{row.DocClassification == 'Required' ? 'label label-success' : 'label label-danger' }}">
                            {{row.DocClassification}}
                        </span>
                    </td>
                    <td class="col-lg-1 col-md-1 col-sm-1 text-center">
                        <button type="button" class="btn btnEdit btn-sm btn-primary btn-flat btnEdit" data-ng-click="toggleUpdateDocument(row)"><i class="fa fa-edit"></i> Edit</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="table-responsive">
        <table class="table table-condensed table-bordered table-striped table-hover pnlView">
            <thead>
                <tr>
                    <th>Property Name</th>
                    <th>Property Type</th>
                    <th>Serial</th>
                    <th>Is Required</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="row in typePropCollection">
                    <td class="col-lg-1 col-md-1 col-sm-1">{{row.PropertyName}}</td>
                    <td class="col-lg-4 col-md-4 col-sm-4">{{row.PropertyType}}</td>
                    <td class="col-lg-1 col-md-1 col-sm-1">{{row.PropertySL}}</td>
                    <td class="col-lg-1 col-md-1 col-sm-1 text-center">
                        <span ng-attr-class="{{row.IsRequired ? 'label label-success' : 'label label-danger' }}">
                            {{row.IsRequired ? 'Required':'Optional'}}
                        </span>
                    </td>
                    <td class="col-lg-1 col-md-1 col-sm-1 text-center">
                        <button type="button" class="btn btnEdit btn-sm btn-primary btn-flat btnEdit" data-ng-click="toggleUpdateProperty(row)"><i class="fa fa-edit"></i> Edit</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <form name="docPropFrm" id="docPropFrm" novalidate>
        <div class="bs-example">
            <!-- Modal HTML -->
            <div id="addModalDoc" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h3 class="modal-title">Document Entry Form</h3>
                        </div>
                        <div class="modal-body">
                            <div class="box-body">
                                <div class="row">
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label for="ownerLevel">Owner Level</label>
                                            <select class="form-control" ng-model="vmBase.OwnerLevel" name="ownerLevel" ng-required="true"
                                                    ng-options="ownerLevel as ownerLevel.LevelName for ownerLevel in ownerLevels track by ownerLevel.OwnerLevelID">
                                                <option value="">-- Select One --</option>
                                            </select>

                                            <div ng-show="docPropFrm.$submitted || docPropFrm.ownerLevel.$touched">
                                                <span ng-show="!docPropFrm.ownerLevel.$dirty && docPropFrm.ownerLevel.$pristine" class="label label-danger">Please select an owner level.</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label>Owner</label>

                                            <select name="owner" class="form-control" ng-model="vmBase.Owner" data-ng-options="owner as owner.OwnerName for owner in ownersForSpecificOwnerLevel track by owner.OwnerID"
                                                    data-ng-disabled="!vmBase.OwnerLevel" ng-required="true">
                                                <option value="">-- Select One --</option>
                                            </select>

                                            <div ng-show="docPropFrm.$submitted || docPropFrm.owner.$touched">
                                                <span ng-show="!docPropFrm.owner.$dirty && docPropFrm.owner.$pristine" class="label label-danger">Please select an owner.</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label>Document Category </label>
                                            <select id="docCategory" name="docCategory" class="form-control" data-ng-model="vmBase.DocCategory" data-ng-options="docCategory as docCategory.DocCategoryName for docCategory in docCategoriesForSpecificOwner track by docCategory.DocCategoryID"
                                                    data-ng-disabled="!vmBase.Owner" ng-required="true">
                                                <option value="">-- Select One --</option>
                                            </select>
                                            <div ng-show="docPropFrm.$submitted || docPropFrm.docCategory.$touched">
                                                <span ng-show="!docPropFrm.docCategory.$dirty && docPropFrm.docCategory.$pristine" class="label label-danger">Please select a document category.</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label>Document Type </label>

                                            <select id="docType" name="docType" class="form-control" data-ng-model="vmBase.DocType" data-ng-options="docType as docType.DocTypeName for docType in docTypeForSpecificDocCategory track by docType.DocTypeID"
                                                    data-ng-disabled="!vmBase.DocCategory" ng-required="true">
                                                <option value="">-- Select One --</option>
                                            </select>

                                            <div ng-show="docPropFrm.$submitted || docPropFrm.docType.$touched">
                                                <span ng-show="!docPropFrm.docType.$dirty && docPropFrm.docType.$pristine" class="label label-danger">Please select a document type.</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label>Stage</label>
                                            <select name="StageMap" class="form-control" ng-model="vmBase.StageMap" data-ng-options="item as item.StageName for item in stageCollection track by item.StageMapID"
                                                    data-ng-disabled="!vmBase.DocType" ng-required="true">
                                                <option value="">-- Select One --</option>
                                            </select>

                                            <div ng-show="docPropFrm.$submitted || docPropFrm.StageMap.$touched">
                                                <span ng-show="!docPropFrm.StageMap.$dirty && docPropFrm.StageMap.$pristine" class="label label-danger">Please provide Property Name.</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label>Document Name</label>
                                            <input type="text" id="DocPropertyName" name="DocPropertyName" data-ng-model="vmDocument.DocPropertyName"
                                                   class="form-control" placeholder="Document Name" ng-maxlength="128" required />
                                            <div ng-show="docPropFrm.$submitted || docPropFrm.DocPropertyName.$touched">
                                                <span ng-show="docPropFrm.DocPropertyName.$error.required" class="label label-danger">Please enter documnet property name</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label>Ordering</label>
                                            <input type="number" data-ng-model="vmDocument.SerialNo" class="form-control" id="SerialNo" placeholder="0" />
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label>Is Required</label>
                                            <select class="form-control" id="ddDocClassification" ng-model="vmDocument.DocClassification" ng-init="vmDocument.DocClassification='Required'">
                                                <option value="Required">Required</option>
                                                <option value="Optional">Optional</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-8 col-md-8 col-lg-8">
                                        <div class="form-group">
                                            <label>Ordering</label>
                                            <div ng-repeat="item in DocumentPermissionModal">
                                                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
                                                    <i class="fa fa-cog"></i>&nbsp;{{item.StageName}}
                                                </div>
                                                <div class="col-lg-2 col-md-2 col-sm-2 col-xs-2">
                                                    <input type="checkbox" ng-model="item.IsChecked" />
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 col-md-4 col-lg-4">
                                        <input type="button" class="btn btn-flat btn-primary pull-right" value="Unselect All" ng-click="UnSelectAll()" />&nbsp;&nbsp;&nbsp;
                                        <input type="button" class="btn btn-flat btn-primary pull-right" value="Select All" ng-click="SelectAll()" />
                                    </div>
                                    </div>
                                </div><!-- /.box-body -->
                        </div>
                        <div class="modal-footer">
                            <div class="col-sm-12 col-md-12 col-lg-12">
                                <div class="form-group">
                                    <button type="submit" id="btnSubmit" class="btn btn-primary btn-flat" ng-click="SaveDocument()" ng-disabled="loading || !docPropFrm.$valid">
                                        Save
                                    </button>
                                    <button type="button" id="btnClose" class="btn btn-default btn-flat" data-dismiss="modal" ng-click="ResetModel()">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <form name="docPropFrmPro" id="docPropFrmPro" novalidate>
        <div class="bs-example">
            <!-- Modal HTML -->
            <div id="addModalPro" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h3 class="modal-title">Property Entry Form</h3>
                        </div>
                        <div class="modal-body">
                            <div class="box-body">
                                <div class="row">
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label for="ownerLevel">Owner Level</label>
                                            <select class="form-control" ng-model="vmBase.OwnerLevel" name="ownerLevel" ng-required="true"
                                                    ng-options="ownerLevel as ownerLevel.LevelName for ownerLevel in ownerLevels track by ownerLevel.OwnerLevelID">
                                                <option value="">-- Select One --</option>
                                            </select>

                                            <div ng-show="docPropFrmPro.$submitted || docPropFrmPro.ownerLevel.$touched">
                                                <span ng-show="!docPropFrmPro.ownerLevel.$dirty && docPropFrmPro.ownerLevel.$pristine" class="label label-danger">Please select an owner level.</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label>Owner</label>

                                            <select name="owner" class="form-control" ng-model="vmBase.Owner" data-ng-options="owner as owner.OwnerName for owner in ownersForSpecificOwnerLevel track by owner.OwnerID"
                                                    data-ng-disabled="!vmBase.OwnerLevel" ng-required="true">
                                                <option value="">-- Select One --</option>
                                            </select>

                                            <div ng-show="docPropFrmPro.$submitted || docPropFrmPro.owner.$touched">
                                                <span ng-show="!docPropFrmPro.owner.$dirty && docPropFrmPro.owner.$pristine" class="label label-danger">Please select an owner.</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label>Document Category </label>
                                            <select id="docCategory" name="docCategory" class="form-control" data-ng-model="vmBase.DocCategory" data-ng-options="docCategory as docCategory.DocCategoryName for docCategory in docCategoriesForSpecificOwner track by docCategory.DocCategoryID"
                                                    data-ng-disabled="!vmBase.Owner" ng-required="true">
                                                <option value="">-- Select One --</option>
                                            </select>
                                            <div ng-show="docPropFrmPro.$submitted || docPropFrmPro.docCategory.$touched">
                                                <span ng-show="!docPropFrmPro.docCategory.$dirty && docPropFrmPro.docCategory.$pristine" class="label label-danger">Please select a document category.</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label>Document Type </label>

                                            <select id="docType" name="docType" class="form-control" data-ng-model="vmBase.DocType" data-ng-options="docType as docType.DocTypeName for docType in docTypeForSpecificDocCategory track by docType.DocTypeID"
                                                    data-ng-disabled="!vmBase.DocCategory" ng-required="true">
                                                <option value="">-- Select One --</option>
                                            </select>

                                            <div ng-show="docPropFrmPro.$submitted || docPropFrmPro.docType.$touched">
                                                <span ng-show="!docPropFrmPro.docType.$dirty && docPropFrmPro.docType.$pristine"
                                                      class="label label-danger">Please select a document type.</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <input type="text" readonly data-ng-model="vmTypeProperty.DocTypePropertyID" class="form-control hidden" id="DocTypePropertyID" placeholder="System Generated Document Code" />

                                            <label>Stage</label>

                                            <select name="StageMap" class="form-control" ng-model="vmBase.StageMap" data-ng-options="item as item.StageName for item in stageCollection track by item.StageMapID" data-ng-disabled="!vmBase.DocType" ng-required="true">
                                                <option value="">-- Select One --</option>
                                            </select>

                                            <div ng-show="docPropFrmPro.$submitted || docPropFrmPro.StageMap.$touched">
                                                <span ng-show="!docPropFrmPro.StageMap.$dirty && docPropFrmPro.StageMap.$pristine" class="label label-danger">Please provide Property Name.</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label>Property Name</label>
                                            <input type="text" maxlength="250" data-ng-model="vmTypeProperty.PropertyName" name="PropertyName" class="form-control" id="PropertyName" placeholder="Property Name" ng-maxlength="50" ng-required="true" />
                                        </div>

                                        <div ng-show="docPropFrmPro.$submitted || docPropFrmPro.PropertyName.$touched">
                                            <span ng-show="!docPropFrmPro.PropertyName.$dirty && docPropFrmPro.PropertyName.$pristine" class="label label-danger">Please provide Property Name.</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label>Property Type</label>
                                            <select class="form-control" id="PropertyType" data-ng-model="vmTypeProperty.PropertyType" ng-init="vmTypeProperty.PropertyType='String'">
                                                <option value="String" selected>String</option>
                                                <option value="Number">Number</option>
                                                <option value="Date">Date</option>
                                                <option value="Boolean">Boolean</option>
                                                <option value="List">List</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label>Property Serial</label>
                                            <input type="number" data-ng-model="vmTypeProperty.PropertySL" class="form-control" id="PropertySL" placeholder="0" />
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label>Is Required</label>
                                            <input type="checkbox" ng-model="vmTypeProperty.IsRequired" id="IsRequired" />
                                        </div>
                                    </div>
                                </div>

                                <div class="row" ng-if="vmTypeProperty.PropertyType=='List'">
                                    <table class="table table-condensed table-bordered table-striped table-hover pnlView">
                                        <thead>
                                            <tr>
                                                <th>
                                                    Field Name
                                                </th>
                                                <th>
                                                    Data Type
                                                </th>
                                                <th>
                                                    Max Size
                                                </th>
                                                <th>
                                                    Master
                                                </th>
                                                <th>
                                                    Action
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr ng-repeat="item in fields track by $index">
                                                <td>
                                                    <input type="text" class="form-control" ng-model="fields[$index].FieldTitle" placeholder="Field Name" />
                                                </td>
                                                <td>
                                                    <select class="form-control" ng-model="fields[$index].DataType">
                                                        <option value="NVARCHAR">NVARCHAR</option>
                                                        <option value="INT">INT</option>
                                                        <option value="DATETIME">DATETIME</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control" ng-model="fields[$index].MaxSize" ng-disabled="" />
                                                </td>
                                                <td>
                                                    <select class="form-control" ng-model="fields[$index].Master">
                                                        <option value="">--Select--</option>
                                                        <option value={{item.MasterTableID}} ng-repeat="item in Masters">{{item.MasterTableName}}</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-xs btn-danger" ng-click="removeField($index)">X</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="4">
                                                    <button type="button" class="btn btn-info" ng-click="addNewField()">Add New Field</button>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>

                                    <div ng-repeat="item in stages track by $index">
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="form-group row" ng-class="{'has-error' : stageForm[$index + '_stageName'].$invalid && (stageForm[$index + '_stageName'].$touched || stageForm.$submitted)}">
                                                    <div class="col-sm-4">
                                                        <label for="{{$index}}_stageName" class="control-label">Stage Name:</label>
                                                    </div>
                                                    <div class="col-sm-8">
                                                        <input type="text" class="form-control" name="{{$index}}_stageName" ng-model="stages[$index].stageName" uib-typeahead="state as state.StageName for state in stageModels | filter:$viewValue" ng-required="true" />
                                                        <span class="help-block" ng-if="stageForm[$index + '_stageName'].$error.required && (stageForm[$index + '_stageName'].$touched || stageForm.$submitted)">Stage Name is Required.</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-sm-6">
                                                <div class="row">
                                                    <div class="col-sm-12 text-left">
                                                        <label for="{{$index}}_hasParallel" class="control-label">Parallel? </label>
                                                        <input type="checkbox" name="{{$index}}_hasParallel" ng-model="stages[$index].hasParallel" />
                                                        <button type="button" ng-click="removeStage($index)" class="btn btn-warning btn-xs" style="margin-left:15px"><i class="fa fa-remove"></i></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div><!-- /.box-body -->
                        </div>
                        <div class="modal-footer">
                            <div class="col-sm-12 col-md-12 col-lg-12">
                                <div class="form-group">
                                    <button type="submit" id="btnSubmit" class="btn btn-primary btn-flat"
                                            ng-click="SaveProperty()" ng-disabled="loading || !docPropFrmPro.$valid">
                                        Save Property
                                    </button>
                                    <button type="button" id="btnClose" class="btn btn-default btn-flat" data-dismiss="modal" ng-click="ResetModel()">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div id="mydiv" data-ng-show="loading">
        <div class="overlay">
            <i class="fa fa-refresh fa-spin"></i>Loading...
        </div>
    </div>
</div>

<script type="text/javascript">
    app.controller('ownerCtrl', function ($scope, $http) {
        //applySecurity();

        $scope.stageCollection = [];
        $scope.documentsCollection = [];
        $scope.typePropCollection = [];
        $scope.DocumentPermissionModal = [];
        $scope.vmBase = {
            StageMap: {StageMapID:"", StageName: ""},
            DocType: { DocTypeID: "", DocTypeName: "" },
            DocCategory: { DocCategoryID: "", DocCategoryName: "" },
            OwnerLevel: { OwnerLevelID: "", LevelName: "" },
            Owner: { OwnerID: "", OwnerName: "" }
        }

        $scope.vmDocument =
        {
            DocPropertyID: "",
            OwnerLevelID: "",
            OwnerID: "",
            DocCategoryID: "",
            DocTypeID: "",
            StageMapID: 0,
            UDDocPropertyCode: "",
            DocPropertyName: "",
            Remarks: "",
            DocClassification: "",
            Status: ""
        };

        $scope.vmTypeProperty =
        {
            DocTypePropertyID: "",
            OwnerID: "",
            DocCategoryID: "",
            DocTypeID: "",
            StageMapID: 0,
            PropertyName:"",
            PropertyType : "",
            PropertySL : "",
            IsRequired : ""
        };

        $http.get('/DocScanningModule/OwnerProperIdentity/GetOwnerLevel?_OwnerLevelID=')
        .success(function (response) {
            $scope.vmBase.OwnerLevel = "";
            $scope.ownerLevels = response.result;
            $scope.loading = false;
        })
        .error(function () {
            $scope.loading = false;
        });

        $scope.$watch('vmBase.OwnerLevel', function (newVal) {
            if (newVal) {
                $scope.vmBase.Owner = "";
                $scope.vmBase.DocCategory = "";
                $scope.vmBase.DocType = "";
                $scope.vmBase.StageMap = "";

                $http.post('/DocScanningModule/OwnerProperIdentity/GetOwnerForSpecificOwnerLevel',
                    { _OwnerLevelID: $scope.vmBase.OwnerLevel.OwnerLevelID })
                    .success(function (response) {
                        $scope.ownersForSpecificOwnerLevel = response.result;
                        $scope.loading = false;
                    }).error(function () {
                        $scope.loading = false;
                    });
            }
        });

        $scope.$watch('vmBase.Owner', function (newVal) {
            if (newVal) {
                $scope.vmBase.DocCategory = "";
                $scope.vmBase.DocType = "";
                $scope.vmBase.StageMap = "";

                $http.post('/DocScanningModule/OwnerProperIdentity/GetDocumentCategoriesForSpecificOwner',
                    { _OwnerID: $scope.vmBase.Owner.OwnerID })
                    .success(function (response) {
                        $scope.docCategoriesForSpecificOwner = response.result;
                        $scope.loading = false;
                    }).error(function () {
                        $scope.loading = false;
                    });
            }
        });

        $scope.$watch('vmBase.DocCategory', function (newVal) {
            if (newVal) {
                $scope.vmBase.DocType = "";
                $scope.vmBase.StageMap = "";

                $http.post('/DocScanningModule/OwnerProperIdentity/GetDocumentTypeForSpecificDocCategory',
                    {
                        _DocCategoryID: $scope.vmBase.DocCategory.DocCategoryID,
                        _OwnerID: $scope.vmBase.Owner.OwnerID
                    })
                    .success(function (response) {
                        $scope.docTypeForSpecificDocCategory = response.result;
                        $scope.loading = false;
                    }).error(function () {
                        $scope.loading = false;
                    });
            }
        });

        $scope.$watch('vmBase.DocType', function (newVal) {
            if (newVal) {
                $scope.vmBase.StageMap = "";

                var url = '/WorkflowModule/WorkflowSetup/GetsPECIFICStagesForType?DocCategoryID=' + $scope.vmBase.DocCategory.DocCategoryID + ' &OwnerID=' + $scope.vmBase.Owner.OwnerID + ' &DocTypeID=' + $scope.vmBase.DocType.DocTypeID + '';
                $http.get(url).success(function (response) {
                    $scope.stageCollection = response.obj;
                    $scope.loading = false;
                }).error(function () {
                    $scope.loading = false;
                    toastr.error('Data Loading Faild.');
                });
            }
        });

        $scope.$watch('vmBase.StageMap', function (newVal) {
            if (newVal) {
                $scope.loadDocumentTable();
                $scope.loadPropertyTable();
            }
        });

        $scope.loadDocumentTable = function () {
            if ($scope.vmBase.DocType.DocTypeID != "")
            {
                var url = '/WorkflowModule/WorkflowSetup/GetAllDocuments?DocCategoryID=' + $scope.vmBase.DocCategory.DocCategoryID + ' &OwnerID=' + $scope.vmBase.Owner.OwnerID + ' &DocTypeID=' + $scope.vmBase.DocType.DocTypeID + '&StageMapID=' + $scope.vmBase.StageMap.StageMapID + '';
                $http.get(url).success(function (response) {
                    $scope.documentsCollection = response.result;
                    $scope.loading = false;
                }).error(function () {
                    $scope.loading = false;
                    toastr.error('Data Loading Faild.');
                });
            }
        }

        $scope.loadPropertyTable = function () {
            if ($scope.vmBase.DocType.DocTypeID != "") {
                var url = '/WorkflowModule/WorkflowSetup/GetALLStageProperty?DocCategoryID=' + $scope.vmBase.DocCategory.DocCategoryID + ' &OwnerID=' + $scope.vmBase.Owner.OwnerID + ' &DocTypeID=' + $scope.vmBase.DocType.DocTypeID + '&StageMapID=' + $scope.vmBase.StageMap.StageMapID + '';
                $http.get(url).success(function (response) {
                    $scope.typePropCollection = response.tp;
                    $scope.loading = false;
                }).error(function () {
                    $scope.loading = false;
                    toastr.error('Data Loading Faild.');
                });
            }
        }

        //############## Toggle Add Document Modal ########################

        $scope.toggleAddDocument = function () {
            $scope.vmDocument.DocPropertyID = "";
            $scope.vmDocument.OwnerLevelID ="";
            $scope.vmDocument.OwnerID = "";
            $scope.vmDocument.DocCategoryID = "";
            $scope.vmDocument.DocTypeID = "";
            $scope.vmDocument.UDDocPropertyCode = "";
            $scope.vmDocument.DocPropertyName = "";
            $scope.vmDocument.Remarks = "";
            $scope.vmDocument.Status = "1";
            $scope.vmDocument.SerialNo = "";
            $http.post('/WorkflowModule/WorkflowSetup/GetChildStages',
                {
                   
                    StageMapID: $scope.vmBase.StageMap.StageMapID
                  

                })
                .success(function (response) {
                    $scope.DocumentPermissionModal = response.obj;
                    console.log($scope.DocumentPermissionModal);
                    $scope.loading = false;
                }).error(function () {
                    $scope.loading = false;
                });
            $('#addModalDoc').modal('show');
        };
        $scope.SelectAll = function () {
            angular.forEach($scope.DocumentPermissionModal, function (item) {
                item.IsChecked = true;
            })
        };

        $scope.UnSelectAll = function () {
            angular.forEach($scope.DocumentPermissionModal, function (item) {
                item.IsChecked = false;
            })
        };
        $scope.toggleAddProperty = function () {
            $scope.vmTypeProperty.DocTypePropertyID = "";
            $scope.vmTypeProperty.OwnerID = "";
            $scope.vmTypeProperty.DocCategoryID = "";
            $scope.vmTypeProperty.DocTypeID = "";
            $scope.vmTypeProperty.PropertyName = "";
            $scope.vmTypeProperty.PropertySL = "";
            $scope.vmTypeProperty.IsRequired = false;
            $('#addModalPro').modal('show');
        };

        $scope.toggleUpdateDocument = function (row) {
            $scope.vmDocument.DocPropertyID = row.DocPropertyID;
            $scope.vmDocument.OwnerLevelID = row.OwnerLevelID;
            $scope.vmDocument.OwnerID = row.OwnerID;
            $scope.vmDocument.DocCategoryID = row.DocCategoryID;
            $scope.vmDocument.DocTypeID = row.DocTypeID;
            $scope.vmDocument.UDDocPropertyCode = row.UDDocPropertyCode;
            $scope.vmDocument.DocPropertyName = row.DocPropertyName;
            $scope.vmDocument.DocClassification = row.DocClassification;
            $scope.vmDocument.SerialNo = row.SerialNo;
            $scope.vmDocument.Remarks = "";
            $scope.vmDocument.Status = "1";
            $http.post('/WorkflowModule/WorkflowSetup/GetChildStages',
                {

                    StageMapID: $scope.vmBase.StageMap.StageMapID


                })
                .success(function (response) {
                    $scope.DocumentPermissionModal = response.obj;
                    console.log($scope.DocumentPermissionModal);
                    $scope.loading = false;
                }).error(function () {
                    $scope.loading = false;
                });
            $http.post('/WorkflowModule/WorkflowSetup/GetDocumentWisePermission',
                {

                    DocPropertyID: $scope.vmDocument.DocPropertyID


                })
                .success(function (response) {
                    console.log(response.obj);
                    angular.forEach($scope.DocumentPermissionModal, function (item) {
                        //console.log(item);
                        for (var i = 0; i < response.obj.length; i++)
                        {
                            //console.log(item)
                            if (response.obj[i] == item.StageMapID) {
                                item.IsChecked = true;
                            }
                        }
                }   
                    );
                    $scope.loading = false;
                }).error(function () {
                    $scope.loading = false;
                });
          
            $('#addModalDoc').modal('show');
        };

        $scope.toggleUpdateProperty = function (row) {
            $scope.vmTypeProperty.DocTypePropertyID = row.DocTypePropertyID;
            $scope.vmTypeProperty.DocCategoryID = row.DocCategoryID;
            $scope.vmTypeProperty.DocTypeID = row.DocTypeID;
            $scope.vmTypeProperty.PropertyName = row.PropertyName;
            $scope.vmTypeProperty.PropertySL = row.PropertySL;
            $scope.vmTypeProperty.IsRequired = row.IsRequired;
            $('#addModalPro').modal('show');
        };

        $scope.SaveProperty = function () {
            $scope.vmTypeProperty.OwnerID = $scope.vmBase.Owner.OwnerID;
            $scope.vmTypeProperty.DocCategoryID = $scope.vmBase.DocCategory.DocCategoryID;
            $scope.vmTypeProperty.DocTypeID = $scope.vmBase.DocType.DocTypeID;
            $scope.vmTypeProperty.StageMapID = $scope.vmBase.StageMap.StageMapID;
            $scope.vmTypeProperty.TableProperties = $scope.fields;

            $scope.loading = true;

            $http.post('/WorkflowModule/WorkflowSetup/AddStageProperty/', JSON.stringify($scope.vmTypeProperty))
            .success(function (data) {
                if (data.Code === "1") {
                    $scope.loadPropertyTable();
                    $scope.loading = false;
                    $('#addModalPro').modal('hide');
                    toastr.success(data.Message);
                }
                else {
                    $scope.loading = false;
                    toastr.error(data.Message);
                }
            }).error(function (data) {
                $scope.loading = false;
                toastr.error('Saved Faild.');
            });
        }

        $scope.SaveDocument = function () {
            $scope.vmDocument.OwnerLevelID = $scope.vmBase.OwnerLevel.OwnerLevelID;
            $scope.vmDocument.OwnerID = $scope.vmBase.Owner.OwnerID;
            $scope.vmDocument.DocCategoryID = $scope.vmBase.DocCategory.DocCategoryID;
            $scope.vmDocument.DocTypeID = $scope.vmBase.DocType.DocTypeID;
            $scope.vmDocument.StageMapID = $scope.vmBase.StageMap.StageMapID;
            $scope.loading = true;
            SelectedObj = [];

            angular.forEach($scope.DocumentPermissionModal, function (item) {
                if (item.IsChecked) {
                    SelectedObj.push(item);
                };
            });
            console.log(SelectedObj);
            $http.post('/WorkflowModule/WorkflowSetup/AddNewDocument/', {
                objDocProperty: $scope.vmDocument,
                DocumentPermissionModal: SelectedObj
            })
            .success(function (data) {
                if (data.respStatus.Status === "1") {
                    $scope.loadDocumentTable();
                    $scope.loading = false;
                    $('#addModalDoc').modal('hide');
                    toastr.success(data.Message);
                }
                else {
                    $scope.loading = false;
                    toastr.error(data.Message);
                }
            }).error(function (data) {
                $scope.loading = false;
                toastr.error('Saved Faild.');
            });
        }

        $scope.DocToggleEdit = function (row) {
            $scope.vmDocument.DocPropertyID = row.DocPropertyID;
            $scope.vmDocument.OwnerLevelID = row.OwnerLevelID;
            $scope.vmDocument.OwnerID = row.OwnerID;
            $scope.vmDocument.DocCategoryID = row.DocCategoryID;
            $scope.vmDocument.DocTypeID = row.DocTypeID;
            $scope.vmDocument.UDDocPropertyCode = row.UDDocPropertyCode;
            $scope.vmDocument.DocPropertyName = row.DocPropertyName;
            $scope.vmDocument.Remarks = row.Remarks;
            $scope.vmDocument.SerialNo = row.SerialNo;
            $scope.vmDocument.DocClassification = row.DocClassification;
            $scope.vmDocument.SerialNo = row.SerialNo;
            $scope.vmDocument.Status = (row.Status).toString();
            $scope.docPropFrm.$setPristine();
            $scope.docPropFrm.$setUntouched();
            $scope.docPropFrm.owner.$setDirty();
            $scope.docPropFrm.ownerLevel.$setDirty();
            $scope.docPropFrm.docCategory.$setDirty();
            $scope.docPropFrm.docType.$setDirty();
            $('#addModal').modal('show');
        };

        //#################### Delete Action ###############
        $scope.DocDeleteConfirm = function () {
            var postData = JSON.stringify(convArrToObj($scope.vmDocument));
            $scope.loading = true;
            $http.post('/DocScanningModule/DocProperty/DeleteDocProperty', postData).success(function (data) {
                if (data.respStatus.Status === "1") {
                    //$scope.init();
                    var index = $scope.displayedCollection.indexOf($scope.vmDocument);
                    if (index !== -1) {
                        $scope.displayedCollection.splice(index, 1);
                    }
                    $scope.loading = false;
                    $('#deleteModal').modal('hide');
                    toastr.success(data.Message);
                }
                else {
                    $scope.loading = false;
                    toastr.error(data.Message);
                }

            }).error(function (data) {
                $scope.loading = false;
                toastr.error(data);
            });
        };

        $scope.fields = [];

        var field = {
            FieldTitle: '',
            DataType: 'NVARCHAR',
            MaxSize: 50,
            Master : ''
        };

        $scope.fields.push(field);

        $scope.addNewField = function () {
            $scope.fields.push({
                FieldTitle: '',
                DataType: 'NVARCHAR',
                MaxSize: 50,
                Master: ''
            });
        };

        $scope.removeField = function (z) {
            $scope.fields.splice(z, 1);
        };

        $scope.Masters = [];
        $http.get('/WorkflowModule/MasterManage/GetMasterForTableType').then(
            function (s) {
                $scope.Masters = s.data.prm;
            },
            function (e) {

            })
        //#################### Set Dropdown ################
        $scope.toggleRefreshTable = function () {
            $scope.loading = true;
            $scope.loadDocPropertyTable();
        };
    });
</script>
